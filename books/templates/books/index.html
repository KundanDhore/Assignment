<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookstore Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
    <h1 class="text-center mb-4">Bookstore Manager</h1>

    <div class="card mb-4">
        <div class="card-header">Manage Books</div>
        <div class="card-body">
            <form id="book-form">
                <input type="hidden" id="book-id"> <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" id="title" class="form-control" placeholder="Book Title" required>
                    </div>
                    <div class="col-md-3">
                        <input type="text" id="author" class="form-control" placeholder="Author" required>
                    </div>
                    <div class="col-md-2">
                        <input type="number" id="price" class="form-control" placeholder="Price" step="0.01" required>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100">Save Book</button>
                        <button type="button" onclick="resetForm()" class="btn btn-secondary w-100 mt-2" style="display:none;" id="cancel-btn">Cancel</button>
                    </div>
                </div>
                <div class="mt-2">
                    <textarea id="description" class="form-control" placeholder="Description (Optional)"></textarea>
                </div>
            </form>
        </div>
    </div>

    <table class="table table-striped table-hover bg-white rounded shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>Title</th>
                <th>Author</th>
                <th>Price</th>
                <th>Description</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="books-table-body">
            </tbody>
    </table>
</div>

<script>
    const apiUrl = '/api/books/';

    // 1. CSRF Token Helper (Required for Django POST/PUT/DELETE)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // 2. Fetch and Display Books (READ)
    async function loadBooks() {
        const response = await fetch(apiUrl);
        const books = await response.json();
        const tableBody = document.getElementById('books-table-body');
        tableBody.innerHTML = '';

        books.forEach(book => {
            tableBody.innerHTML += `
                <tr>
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>$${book.price}</td>
                    <td>${book.description}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editBook(${book.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBook(${book.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
    }

    // 3. Handle Form Submit (CREATE & UPDATE)
    document.getElementById('book-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const bookId = document.getElementById('book-id').value;
        const method = bookId ? 'PUT' : 'POST';
        const url = bookId ? `${apiUrl}${bookId}/` : apiUrl;

        const data = {
            title: document.getElementById('title').value,
            author: document.getElementById('author').value,
            price: document.getElementById('price').value,
            description: document.getElementById('description').value
        };

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            resetForm();
            loadBooks();
        } else {
            alert('Error saving book');
        }
    });

    // 4. Delete Book (DELETE)
    async function deleteBook(id) {
        if (confirm('Are you sure you want to delete this book?')) {
            await fetch(`${apiUrl}${id}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrftoken }
            });
            loadBooks();
        }
    }

    // 5. Load Data into Form for Editing
    async function editBook(id) {
        const response = await fetch(`${apiUrl}${id}/`);
        const book = await response.json();

        document.getElementById('book-id').value = book.id;
        document.getElementById('title').value = book.title;
        document.getElementById('author').value = book.author;
        document.getElementById('price').value = book.price;
        document.getElementById('description').value = book.description;

        document.querySelector('button[type="submit"]').textContent = 'Update Book';
        document.getElementById('cancel-btn').style.display = 'block';
    }

    // 6. Reset Form
    function resetForm() {
        document.getElementById('book-form').reset();
        document.getElementById('book-id').value = '';
        document.querySelector('button[type="submit"]').textContent = 'Save Book';
        document.getElementById('cancel-btn').style.display = 'none';
    }

    loadBooks();
</script>

</body>
</html>